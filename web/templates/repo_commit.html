{{ define "repo_commit" }}
{{ $commit := .P.Diff.Commit }}
{{ $diff := .P.Diff.Diff }}
{{ $stat := .P.Diff.Stat }}
{{ $parents := .P.Diff.Parents }}
<html>
  <head>
    {{ template "head" . }}
    <title>{{ .RepoName }}: {{ $commit.HashShort }}</title>
  </head>
  <body>
    {{ template "repo_header" . }}
    <main>
      <section class="commit">
        <div class="commit-refs">
          {{ $stat.FilesChanged }} files changed,
          {{ $stat.Insertions }} insertions(+),
          {{ $stat.Deletions }} deletions(-)
        </div>

        <div class="box">
          <pre class="commit-message">
            {{- if $commit.Message }}{{- $commit.Message -}}
            {{- else -}}<span class="muted">Empty message</span>{{- end -}}
          </pre>
          <div>
            <strong>Author:</strong>
            {{ $commit.AuthorName }}
            <a href="mailto:{{ $commit.AuthorEmail }}" class="commit-email">{{ $commit.AuthorEmail }}</a>
          </div>
          <div>
            <strong>Committed at:</strong>
            {{ $commit.Committed }}
          </div>
          {{ if $commit.ChangeID -}}
          <div>
            <strong>Change ID:</strong>
            {{ $commit.ChangeID }}
          </div>
          {{- end }}
          <div>
            <strong>Parent:</strong>
            {{ range $i, $p := $parents -}}
            {{ if $i }}, {{ end -}}
            <a class="link" href="/{{$.RepoName}}/commit/{{ $p }}">{{ $p }}</a>
            {{- end }}
          </div>
        </div>

        {{ if gt (len $diff) 1 -}}
        <div class="jump">
          <strong>jump to</strong>
          <table class="table jump-table">
            <tbody>
              {{ range $diff }}
              {{ $path := .Name.New }}
              {{ if not $path }}{{ $path = .Name.Old }}{{ end }}
              <tr>
                <td class="diff-type">
                  {{ if .IsNew }}<span class="diff-type diff-add">A</span>{{ end }}
                  {{ if .IsDelete }}<span class="diff-type diff-del">D</span>{{ end }}
                  {{ if not (or .IsNew .IsDelete) }}<span class="diff-type diff-mod">M</span>{{ end }}
                </td>
                <td class="fill">
                  <a href="#{{ $path }}">
                    {{ if and .Name.Old .Name.New }}{{ .Name.Old }} &#8594; {{ .Name.New }}{{ else }}{{ $path }}{{ end }}
                  </a>
                </td>
              </tr>
              {{ end }}
            </tbody>
          </table>
        </div>
        {{ end }}
      </section>
      <section>
        {{ $this := $commit.Hash }}
        {{ $parent := index $parents 0 }}
        {{ range $diff }}
        {{ $path := .Name.New }}
        {{ if not $path }}{{ $path = .Name.Old }}{{ end }}
        <div id="{{ $path }}">
          <div class="diff">
            {{ if .IsNew }}
            <span class="diff-type diff-add">A</span>
            {{ end }}
            {{ if .IsDelete }}
            <span class="diff-type diff-del">D</span>
            {{ end }}
            {{ if not (or .IsNew .IsDelete) }}
            <span class="diff-type diff-mod">M</span>
            {{ end }}
            {{ if .Name.Old }}
            <a href="/{{$.RepoName}}/blob/{{ $parent }}/{{ .Name.Old }}">{{ .Name.Old }}</a>
            {{ if .Name.New }}
            &#8594;
            <a href="/{{$.RepoName}}/blob/{{ $this }}/{{ .Name.New }}">{{ .Name.New }}</a>
            {{ end }}
            {{ else }}
            <a href="/{{$.RepoName}}/blob/{{ $this }}/{{ .Name.New }}">{{ .Name.New }}</a>
            {{- end -}}
            {{ if .IsBinary }}
            <p>Not showing binary file.</p>
            {{ else }}
            <pre>
              {{- range .TextFragments -}}
              <p>{{- .Header -}}</p>
              {{- range .Lines -}}
              {{- if eq .Op.String "+" -}}
              <span class="diff-add">{{ .String }}</span>
              {{- end -}}
              {{- if eq .Op.String "-" -}}
              <span class="diff-del">{{ .String }}</span>
              {{- end -}}
              {{- if eq .Op.String " " -}}
              <span class="diff-noop">{{ .String }}</span>
              {{- end -}}
              {{- end -}}
              {{- end -}}
              {{- end -}}
            </pre>
          </div>
        </div>
        {{ end }}
      </section>
    </main>
  </body>
</html>
{{ end }}
